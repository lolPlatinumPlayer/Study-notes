# 程序设计

### 大方向的设计



**开发项目时的注意点**

- 前端开发前要考虑好复用  
  因为后期肯定都是复用的，所以前期先把复用的组件开发好，整体工期肯定是比开发到一半再把组件提出来更短的



**开发细粒度**

开发过程中，一次搞定一部分而不是全部，这样开发比较舒服，感觉也比较可控。

> 好的架构源于不停地衍变，而非设计。 —— [美团安卓客户端](https://tech.meituan.com/2018/03/16/meituan-food-delivery-android-architecture-evolution.html)（58同城沈剑可能是最早说这话的人）



### 具体的编程

- 不返回数组的话用forEach而不用map，避免对阅读者的误导
- data这种数据就算一开始没有值（或者其后代属性不存在等）
  只要后面有用到的一开始就要写上，赋值为空也可以
- if else这种不要省括号
- if else优先使用二分
- 不要过度封装
- 为了在一个文件里能找到尽可能多的相关代码，其他设计可以做一些牺牲 ？？？
- 条件判断  
  不要写一堆的`||`，尽量做一个枚举的常量出来，比如：`let flag = ["IconSymbol","DivSymbol","PopupSymbol"].some(o=>o===this._symbol.getType())`
- 代码从核心逻辑写出来会更加轻松  
  因为核心的分支基本上都是比周边的分支要少的  
  周边的内容漏写总比核心的内容漏写要好
- 有副作用的函数尽量少写，可读性不好
- 多种状态的页面，如果面对后面还会新增状态的话，判断写是否是某些状态会比较好，这样后期加状态会比较清晰

**函数参数设计**

- 在参数少的时候可能不用配置项是更合适的  
  用配置项的话一定要仔细斟酌属性名，不然改属性名的话比较麻烦





### 类的开发方案

源自为鑫

- 类的单个方法传参不要过多，过多时拆成多个方法，方法过多时拆成多个类。
- 削减类的代码量的方法：
  1. 使用纯函数拆分
  2. 使用工具类拆分

个人经验

- 设计类时不要设计出绑定this指向的方法  
  （这条只能算个人编码风格，没在社区里发现这样的共识）  
  - 原因：  
    - 有的代码环境会改变方法的this指向  
      如果我们绑定了this指向，那在阅读这样的代码时就会误以为这个环境不会更改this指向
    - 如果是用`bind`来绑定的话  
      在chrome开发者工具里“修改源码”的功能将会变得误导人  
      因为`bind`后已经是另一个函数了  
      而chrome的“修改源码”功能并不会重新解析整份js，大约就是在用到某个方法时，使用修改后的代码  
      所以最终的结果就是『在这种时候“修改源码”功能』将会失效
  - 相反意见：  
    - 一个实例的方法的this只应该指向实例本身
    - react圈子里『在构造函数里对方法用`bind`重新赋值』是很普遍的操作
    - 成阳建议『在构造函数里对部分方法用`bind`重新赋值』

- 就算一种对象不需要批量使用，用class似乎也更好，起码能把方法丢到原型链上，在控制台打印的时候看起来方便



### 面向对象

源自成阳

##### 继承

子类按照父类的规范来扩展

（算是一个面对接口编程的编程方式）

##### 组合

拥有另一个类的实例



### 使用html、js混合的库

jsx、模板语法都将html和js混合在了一起

- [mixin的缺点](https://reactjs.org/blog/2016/07/13/mixins-considered-harmful.html)  
  👆这篇文章的一句话很有代表性：“一旦编写，mixin 就很难删除或更改。糟糕的想法不会被重构掉，因为重构风险太大。”



### 设计库

- 在库有一定规模的时候  
  用户看示例会比看文档好理解很多  
  而且用户开发的时候可以直接复制示例代码，就很简单










# 调试技巧
- 就算程序能正常运行也要关注报错信息，至少留个印象
- 两次测试间跨步不要太大
- 排错尽量往 自己可掌控部分 思考
- 去编译后的代码里调试基本没结果（尤其是three和whs部分）
- 尽量不要去依赖的源码里排错（尤其是three和whs部分）
- 对于深层报错（比如用whs报webGL或runtime错误）尽量放弃调试，从代码本身找问题



# 重构

重构别人代码的难点

- 一般要重构的代码质量都比较差
- 要花时间阅读
- 重构代码结构难调整
- 最终出来的结构不理想，未来难阅读  
  尤其是复杂代码，没有结构说明极难阅读





# 概念



### 类中事件与方法的区别

- **语义不同**  
  事件比方法多了一个限制条件：在发生指定事情时执行代码片段
- **操作不同**  
  事件有一组方法进行增、减、触发等操作  
  这些操作可以随时进行，所以比方法灵活很多
- **实现不同**  
  js的类中没有事件相关的api  
  因此事件功能都是js程序员手动封装的  
  不同方式实现的事件间都会有些许不同



### 状态机

全称是有限状态自动机  
是一个数学模型  
给定一个状态机，同时给定它的当前状态以及输入，那么输出状态是可以明确的运算出来的

##### 四大概念

- State ，状态  
  一个状态机至少要包含两个状态。例如上面自动门的例子，有 open 和 closed 两个状态。

- Event ，事件  
  事件就是执行某个操作的触发条件或者口令。对于自动门，“按下开门按钮”就是一个事件。

- Action ，动作  
  事件发生以后要执行动作。例如事件是“按开门按钮”，动作是“开门”。编程的时候，一个 Action 一般就对应一个函数。

- Transition ，变换  
  也就是从一个状态变化为另一个状态。例如“开门过程”就是一个变换。



# 算法



### 递归

- 不引入函数外变量，不用引用传递的话，单次递归返回全部处理后的树的方法

  ```javascript
  const 模拟数据=[
      [
          112,
          213,
          [
              334,
              544
          ]
      ],
      772,
      [
          888
      ]
  ]
  console.log('结果',kk(模拟数据))
  
  function kk(arr) {
      let resultOfThisLevel=[]
      if(isArr(arr)){
          for (let i=0;i<arr.length;i++){
              resultOfThisLevel=[...resultOfThisLevel,...kk(arr[i])]
          }
          return resultOfThisLevel
      }else {
          return [arr]
      }
  }
  function isArr (o) {
      return Object.prototype.toString.call(o) === '[object Array]';
  }
  ```





### 推荐算法

可以看《案例1-基于SparkMlib协同过滤电源推荐系统》（2021.5.11hrt钉钉直播回放）






# 其他
- 自己要做code-review
- 设计算法时自己一定要理解每一步的情况（要有数学模型），明确每个变量代表什么。不然到后面也要重新理解，因为很容易出问题
- 写递归时要注意避免死循环  
  可以先写好循环体，然后测一下  
  确认没有死循环后再加入主体内容
- 在多人开发的项目上养成在dev分支上开发的习惯（开发后先在dev分支把主支的代码合并过来，再去主支把dev分支的代码合并过来，这样主支合并时就不会有任何问题，甚至不会生成commit）  
  虽然大部分时候和在master上开发没有区别  
  但是有的时候要将当前代码和master进行比较  
  这个时候就有用了  
  （只是checkout到历史commit的话只能看不能改）
- 关于代码变更的详细信息记录在commit里会比较合适
- 对于有性能消耗的程序要记录性能情况  
  以便在未来优化性能的时候有指标来说明性能的提升幅度
- 就算只用一个对象，用`class`生成也是更好的方案，用`class`有如下好处
  - 有更良好的对象表达方式（比如私有属性、构造函数）
  - 未来如果要批量产生对象，那就不需要再把对象写成类
- 使用的东西（变量或函数、类之类的）用底层的会比用上层的更好  
  这样代码就更容易做到可拔插  
  阅读某一块代码时需要阅读的前置代码也会更少
- 封装数据时带上键名会更好  
  都是数组的话以后可能会不知道子项的意义  
  相比于搞不清代码的意义，在调试时多点一下鼠标会轻松得多
- 命名  
  `XX_状态`这种命名尽量少用，不然函数名不好起（比如如果要获得这个变量的话用常见的前面加`get`来命名就不好使，如果加了就会变成`getXX_状态`，这样就有歧义了）
- 用css写样式比js生成样式好调很多  
  （在浏览器里更改很方便，而且可以实时看到效果）
- 缩小体积的方式  
  可以对一些文件进行压缩，读取后再进行解压

